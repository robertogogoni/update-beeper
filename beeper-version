#!/bin/bash
# beeper-version - Quick version status for Beeper Desktop
# Shows installed version, latest available, and AUR package status

set -e

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

BEEPER_API="https://api.beeper.com/desktop/download/linux/x64/stable/com.automattic.beeper.desktop"
INSTALL_DIR="/opt/beeper"

# Check dependencies
if ! command -v curl &>/dev/null; then
    echo -e "${RED}Error: curl is required but not installed${NC}"
    exit 1
fi

# Check architecture
ARCH=$(uname -m)
if [[ "$ARCH" != "x86_64" ]]; then
    echo -e "${YELLOW}Warning: Beeper only supports x86_64. Your arch: $ARCH${NC}"
fi

# Get installed version - check package.json FIRST (source of truth)
# pacman may show AUR version which lags behind direct installs
get_installed_version() {
    local version=""

    # Try package.json first (most accurate - this is what's actually installed)
    if [[ -f "$INSTALL_DIR/resources/app/package.json" ]]; then
        version=$(grep -oP '"version":\s*"\K[0-9]+\.[0-9]+\.[0-9]+' "$INSTALL_DIR/resources/app/package.json" 2>/dev/null | head -1)
    fi

    # Fallback to pacman only if package.json missing (fresh install scenario)
    if [[ -z "$version" ]]; then
        version=$(pacman -Q beeper-v4-bin 2>/dev/null | awk '{print $2}' | cut -d'-' -f1)
    fi

    echo "${version:-not installed}"
}

# Get latest version from Beeper API (with 10s timeout to prevent hanging)
get_latest_version() {
    local download_url version
    download_url=$(curl -Ls -m 10 -o /dev/null -w "%{url_effective}" "$BEEPER_API" 2>/dev/null)
    version=$(echo "$download_url" | grep -oP 'Beeper-\K[0-9]+\.[0-9]+\.[0-9]+')

    # Fallback: try extracting any version pattern if redirect URL changed format
    if [[ -z "$version" ]]; then
        version=$(echo "$download_url" | grep -oP '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    fi

    echo "${version:-unknown}"
}

# Get AUR version (with 10s timeout, using POSIX-compliant [0-9] instead of \d)
get_aur_version() {
    local version
    version=$(curl -sL -m 10 "https://aur.archlinux.org/packages/beeper-v4-bin" 2>/dev/null | \
              grep -oP '4\.[0-9]+\.[0-9]+' | head -1)
    echo "${version:-unknown}"
}

# Version comparison: returns 0 if $1 >= $2
version_gte() {
    printf '%s\n%s\n' "$2" "$1" | sort -V -C
}

# Main
echo ""
echo -e "${BOLD}${CYAN}ğŸ Beeper Version Status${NC}"
echo -e "${DIM}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""

# Fetch all versions (show loading for each)
echo -ne "${DIM}Checking installed...${NC}\r"
INSTALLED=$(get_installed_version)

echo -ne "${DIM}Checking latest...   ${NC}\r"
LATEST=$(get_latest_version)

echo -ne "${DIM}Checking AUR...      ${NC}\r"
AUR=$(get_aur_version)

# Clear the loading line
echo -ne "                           \r"

# Display versions with status indicators
echo -e "  ${BOLD}Installed:${NC}  $INSTALLED"
echo -e "  ${BOLD}Latest:${NC}     $LATEST"
echo -e "  ${BOLD}AUR:${NC}        $AUR"
echo ""

# Analysis
if [[ "$INSTALLED" == "not installed" ]]; then
    echo -e "${RED}  âœ— Beeper is not installed${NC}"
    echo -e "${DIM}    Run: update-beeper${NC}"
elif [[ "$LATEST" == "unknown" ]]; then
    echo -e "${YELLOW}  âš  Could not check latest version (network issue?)${NC}"
elif version_gte "$INSTALLED" "$LATEST"; then
    echo -e "${GREEN}  âœ“ You're on the latest version!${NC}"
else
    echo -e "${YELLOW}  â¬† Update available: $INSTALLED â†’ $LATEST${NC}"
    echo -e "${DIM}    Run: update-beeper${NC}"
fi

# AUR status
if [[ "$AUR" != "unknown" ]] && [[ "$LATEST" != "unknown" ]]; then
    if version_gte "$AUR" "$LATEST"; then
        echo -e "${GREEN}  âœ“ AUR is up to date${NC}"
    else
        # Only calculate BEHIND if both are valid semver
        if [[ "$AUR" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] && [[ "$LATEST" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            BEHIND=$((${LATEST##*.} - ${AUR##*.}))
            echo -e "${DIM}  â„¹ AUR is behind by ~$BEHIND releases${NC}"
        fi
    fi
fi

echo ""
